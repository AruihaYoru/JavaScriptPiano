# JavaScriptPiano
ええと、Vanilla JSで動くきわめて高度なピアノシュミレーターです。  
エラーハンドリングはほとんどありません。鳴らないなら、コンソールを見てください。

## やったこと
- 打鍵音、ペダル、ハンマーすべてを再現する。
- 連続する２つ音の高さ差を元にレイテンシを加える
- 生成アルゴリズムの細かなところに1/fゆらぎを多用
- とてつもなく微妙なほどの音量差をつくる（44から離れるほど。中央が一番大きく、っていうものになるはずだから）
- 生楽器の不確定さをすべてピンクノイズで作る。
- 音の空白期間からの復帰の際、最初の鍵に課せられるノイズは少し大きく。
- すべての音のベロシティ、長さ、開始時間にレイテンシ（ノイズ）を加す
- 同時に音を鳴らす際、レイテンシは最も中心に近い鍵を最高として更に大きく。
- 共鳴をきちんと作成する（中央付近は共鳴しやすいっていう）（実際は今抑えている音の倍音とかも）
- 「手」エージェントを2個生成する。（一つの手が鳴らせる音は最大5音で、最高音と最低音の差は12度。）
- 読み込み速度の改善のため、必要なものだけを読み込む。
<!-- しんき -->
- おてての交差や出張
- 疲労概念（フォルテの連続は疲れる、でしょ？）
- ミスタッチ（隣の鍵をかすめてしまった！）
- 跳躍後はミスタッチの確率が増え、ベロシティのレイテンシも大きくなる。
- フォルテで弾くときや、指を立てて弾くとき、鍵盤に「カチッ」という爪が当たる高周波ノイズが混じる。
- 右の鍵盤なら右からなり、左の鍵盤なら左からなる
- 弱く弾くとこもり、強く弾くと開く
- 床鳴りと空気感、木のこもった音
- 「和音のストローク」の自動生成
- 「ハンマーの戻り」の物理限界
- 身を乗り出す行為

<!-- -->
- *さらにあと数個....*<br>
<br>
*注：レイテンシの意味を少しずらしています。遅延を意味する言葉ですが、ここではプラスマイナスどちらかにブレさせるノイズとします。*<br>
また、ノイズことレイテンシはそこまで強くありません。（大きすぎると、不均一ですから。）  
12度も手が開くようになっていますが、いつか減らしてるかも。

## 使いかた
```
git clone https://github.com/AruihaYoru/JavaScriptPiano.git
```
でクローンして、main.jsに楽譜データを貼り付けます。ドキュメントも、main.jsに直書きしています。
<br>注記：音声データだけでも1.1GBです。
## ライセンス
本プロジェクトの音響生成ロジックおよびエージェント・シミュレーションは或いは夜に帰属します。音源サンプルはAlexander Holm氏による[Salamander Grand Piano](https://github.com/sfzinstruments/SalamanderGrandPiano/tree/master)  (CC BY 3.0)を使用しています。


----


# `window.myScore` データ構造仕様書

`MyJavaScriptPiano` は、グローバル変数 `window.myScore` に格納された配列データを読み込み、演奏を行います。  
基本的には、main.jsに記述しておくことをおすすめします。その後、script.jsから呼び出されますので。

## 1. 基本構造

`window.myScore` は **オブジェクトの配列 (Array of Objects)** です。
配列内の各オブジェクトは、1つの「音符（ノート）」を表します。

```javascript
window.myScore = [
    { note: 60, time: 0.0, duration: 1.0, velocity: 0.5 },
    { note: 64, time: 0.5, duration: 1.0, velocity: 0.6 },
    ...
];
```

## 2. オブジェクトのプロパティ

各ノートオブジェクトには、以下の4つのプロパティが必要です。

| プロパティ名 | 型 (Type) | 単位 / 範囲 | 説明 | 必須 |
| :--- | :--- | :--- | :--- | :--- |
| **`note`** | `Number` | 21 ~ 108 | MIDIノート番号（音の高さ）。<br>21=A0, 60=C4(中央ド), 108=C8 | **Yes** |
| **`time`** | `Number` | 秒 (Seconds) | 曲の開始時点を `0.0` とした**絶対時間**。<br>いつ音を鳴らすかを指定します。 | **Yes** |
| **`duration`** | `Number` | 秒 (Seconds) | 音の長さ（ゲートタイム）。<br>鍵盤を押している時間を指定します。 | **Yes** |
| **`velocity`** | `Number` | 0.0 ~ 1.0 | 打鍵の強さ。<br>音量、音色、共鳴音の有無に影響します。 | Optional<br>*(def: 0.5)* |

### プロパティ詳細

#### `note` (MIDI Note Number)
ピアノの88鍵盤に対応する整数値です。
*   **21**: A0 (最低音)
*   **60**: C4 (中央ド)
*   **108**: C8 (最高音)

#### `time` (Start Time)
「前の音からの差分（Delta Time）」ではなく、**曲の頭からの絶対時間**で指定してください。
*   例: 1拍目が `0.0`、2拍目が `0.5` ...
*   **※ エンジンの挙動メモ**: `player.js` はこの時間を「意図したタイミング」として受け取りますが、再生時に**1/fゆらぎ**や**手の移動レイテンシ**を自動加算するため、指定した時間よりもわずかに遅れて発音されることがあります（人間味の演出）。

#### `duration` (Duration)
鍵盤を離すまでの時間です。
*   この時間が経過すると、`rel` (リリースノイズ) が再生され、音が減衰し始めます。

#### `velocity` (Velocity)
*   **0.0 ~ 1.0** の小数で指定します。
*   内部で `1` ~ `16` 段階のサンプル (`v1.wav` ~ `v16.wav`) にマッピングされます。
*   **0.6 以上 (v10相当~)を指定すると**: 強い打鍵とみなされ、共鳴音 (`harmV3`) が自動的にレイヤーされます。

---

## 3. サンプルデータ作成例

以下は、Cメジャーコード（ドミソ）をアルペジオで弾き、最後に和音で終わる例です。

```javascript
window.myScore = [
    // ド (C4)
    { note: 60, time: 0.0, duration: 0.5, velocity: 0.4 },
    // ミ (E4)
    { note: 64, time: 0.5, duration: 0.5, velocity: 0.5 },
    // ソ (G4)
    { note: 67, time: 1.0, duration: 0.5, velocity: 0.6 },
    
    // ジャーン（和音）
    // timeを揃えることで和音として認識されますが、
    // エンジン側で自動的に微細なズレ（ストラミング）が付与されます。
    { note: 60, time: 2.0, duration: 2.0, velocity: 0.8 }, // C4
    { note: 64, time: 2.0, duration: 2.0, velocity: 0.7 }, // E4
    { note: 67, time: 2.0, duration: 2.0, velocity: 0.75 }, // G4
    { note: 72, time: 2.0, duration: 2.0, velocity: 0.9 }  // C5 (強い音 -> 共鳴音あり)
];
```

## 4. エンジン特有の挙動について（作成者向けメモ）

譜面データを作成する際は、以下の点に留意するとよりリアルな演奏になります。

1.  **完全な同時打鍵について**
    *   和音などで `time` を完全に一致させても問題ありません。
    *   `player.js` は同一時刻のノートを検知すると、中央（69番）から遠い鍵盤ほどわずかに発音を遅らせる処理（物理的な指のバラつき再現）を自動で行います。
    *   そのため、譜面データ側で手動で `0.005` 秒ずらす等の微調整を行う必要はありません（やっても良いですが、二重にかかる可能性があります）。

2.  **休符後の挙動**
    *   前のノートから一定時間（約2秒以上）空くと、次のノートの発音時に「迷い」や「位置合わせ」によるノイズ（タイミングの遅れ）が大きめに付与されます。これを意図的に利用して、フレーズの歌い出しを表現できます。

3.  **手のエージェント**
    *   `note < 64` は左手、`note >= 64` は右手のエージェントが担当していると仮定してレイテンシ計算されます。
    *   極端に離れた音（例: C2 から C6）へ急に飛ぶ譜面の場合、物理的な移動時間をシミュレートするため、発音が少し遅れることがあります。

